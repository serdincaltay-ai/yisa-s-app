/**
 * Giriş sonrası rol çözümleme — tek kaynak
 * Öncelik: PATRON_EMAIL > kullanicilar/roller > profiles > user_metadata
 */

import { PATRON_EMAIL } from './roles'

export type ResolvedRole =
  | 'patron'
  | 'franchise'
  | 'firma_sahibi'
  | 'isletme_muduru'
  | 'tesis_sahibi'
  | 'antrenor'
  | 'veli'

const PATRON_VARIANTS = ['patron', 'Patron', 'PATRON', 'ROL-0', 'rol-0']
const FRANCHISE_VARIANTS = ['franchise', 'firma_sahibi', 'Franchise Sahibi', 'ROL-1', 'rol-1']
const VELI_VARIANTS = ['veli', 'Veli', 'ROL-10', 'rol-10']

function normalizeRole(raw: string | undefined | null): ResolvedRole | null {
  if (!raw || typeof raw !== 'string') return null
  const r = raw.trim().toLowerCase()
  if (PATRON_VARIANTS.some((v) => v.toLowerCase() === r)) return 'patron'
  if (FRANCHISE_VARIANTS.some((v) => v.toLowerCase() === r)) return 'franchise'
  if (['isletme_muduru', 'tesis_sahibi', 'tesis müdürü'].some((v) => r.includes(v.replace(/\s/g, '')))) return 'tesis_sahibi'
  if (['antrenor', 'antrenör'].some((v) => r.includes(v))) return 'antrenor'
  if (VELI_VARIANTS.some((v) => v.toLowerCase() === r)) return 'veli'
  return null
}

export interface ResolveRoleInput {
  userId: string
  email?: string | null
  userMetadata?: Record<string, unknown>
  profilesRole?: string | null
  kullanicilarRolKod?: string | null
}

/**
 * Giriş sonrası rolü çözümle — panel yönlendirmesi için
 */
export function resolveLoginRole(input: ResolveRoleInput): ResolvedRole {
  const { email, userMetadata, profilesRole, kullanicilarRolKod } = input

  // 1. Patron e-posta (en yüksek öncelik)
  if (email && email.toLowerCase() === PATRON_EMAIL.toLowerCase()) {
    return 'patron'
  }

  // 2. kullanicilar.roller.kod (veritabanı rolü)
  const fromKullanici = normalizeRole(kullanicilarRolKod ?? undefined)
  if (fromKullanici) return fromKullanici

  // 3. profiles.role
  const fromProfile = normalizeRole(profilesRole ?? undefined)
  if (fromProfile) return fromProfile

  // 4. user_metadata.role
  const metaRole = userMetadata?.role as string | undefined
  const fromMeta = normalizeRole(metaRole)
  if (fromMeta) return fromMeta

  return 'veli'
}

/** Rol → yönlendirme yolu */
export const ROLE_TO_PATH: Record<ResolvedRole, string> = {
  patron: '/dashboard',
  franchise: '/franchise',
  firma_sahibi: '/franchise',
  isletme_muduru: '/tesis',
  tesis_sahibi: '/tesis',
  antrenor: '/antrenor',
  veli: '/veli',
}
